import os
# from langchain.llms import Qwen
from langchain.prompts import PromptTemplate
from langchain.chains import LLMChain  
from langchain_community.llms import Tongyi
from typing import List, Dict, Any, Optional # Added type hints

class DocumentPrase:
    def __init__(self) -> None:
        pass

    
    def extract_paragraphs(self, node):
        if not node:
            return []
        
        output = []

        for item in node:
            title_list = []
            self.extract_paragraph(item, output, title_list)
        return output


    def extract_paragraph(self, item, result, title_list):

        if not item:
            return
        current_title = item.get("title", "")
        paragraph = item.get("paragraphs", [])
        children = item.get("children", [])

        #current_titles = title_list + [current_title]
        title_list = title_list[:]
        title_list.append(current_title)

        if paragraph:
            result.append({'title':title_list, 'paragraph':paragraph, 'length': sum(len(s) for s in paragraph)})


        for child in children:
            self.extract_paragraph(child, result, title_list)



 
class SummaryGenerator:
    def __init__(self, model_name="qwen-plus"):
        """初始化摘要生成器

        Args:
            model_name (str): 要使用的 DashScope/Bailian 模型名称。
                              常见选项: "qwen-turbo", "qwen-plus", "qwen-max",
                              "qwen-max-longcontext" 等。
                              请参考 DashScope 文档获取最新列表和适用场景。
        """
        # 从环境变量获取 API Key (Recommended)
        # api_key = os.getenv("DASHSCOPE_API_KEY")
        # Using the provided key for this example
        current_api_key = 'sk-ff2f7a46bc0f412c9ae4915a2829465c'  # Use the key defined above
        if not current_api_key:
            raise ValueError("请设置 DASHSCOPE_API_KEY 环境变量或在代码中提供 API Key")

        # 初始化 Tongyi (Qwen) 模型 via DashScope
        self.llm = Tongyi(
            model_name=model_name,
            dashscope_api_key=current_api_key
            # temperature=0.7 # Optional: Add other parameters
        )

        # 定义摘要生成的提示模板 (保持不变)
        self.summary_template = """
        请为以下文本生成一个简洁的摘要，包含文档的主要内容和关键观点:

        {text}

        摘要:
        """

        self.prompt = PromptTemplate(
            input_variables=["text"],
            template=self.summary_template
        )

        # 创建 LLM 链 (保持不变)
        self.chain = LLMChain(llm=self.llm, prompt=self.prompt)

    def generate_section_summary(self, section_text: str) -> Optional[str]:
        """为单个章节生成摘要

        Args:
            section_text: 章节文本内容

        Returns:
            str: 章节摘要 或 None (如果出错)
        """
        if not section_text or section_text.isspace():
             print("警告: 章节文本为空，跳过摘要生成。")
             return ""  # 返回空字符串而不是 None，以便后续拼接

        try:
            # 使用 run 方法调用 LLMChain (simple use case)
            summary = self.chain.run(text=section_text)
            # For more control or structured output, consider invoke:
            # response = self.chain.invoke({"text": section_text})
            # summary = response.get('text', '') # Adjust key based on actual output
            return summary.strip()  #去除可能的多余空格
        except Exception as e:
            print(f"生成章节摘要时发生错误: {str(e)}")
            # Consider more specific exception handling (e.g., API errors, rate limits)
            return None

    def generate_document_summary(self, document_data: List[Dict[str, Any]]) -> Optional[Dict[str, Any]]:
        """为整个文档生成摘要

        Args:
            document_data (List[Dict[str, Any]]): 文档各章节数据的列表。
              每个字典应包含 'title' (List[str]), 'paragraph' (List[str]),
              和可选的 'length' (int)。
              例如:
              [
                {'title': ['引言', '研究背景'], 'paragraph': ['...', '...'], 'length': 58},
                {'title': ['方法', '数据处理'], 'paragraph': ['...', '...'], 'length': 52},
                ...
              ]

        Returns:
            dict: 包含各章节摘要和整体摘要的字典, 或 None (如果出错)
                  格式: {'section_summaries': { '标题1 - 子标题1': '摘要1', ... }, 'overall_summary': '总摘要'}
        """
        if not document_data:
            print("错误: 输入的章节数据列表为空。")
            return None

        try:
            section_summaries = {}
            all_section_texts_for_overall = []  # 用于收集摘要以生成总摘要

            print("开始生成章节摘要...")
            for i, section_info in enumerate(document_data):
                # --- Modification Start ---
                # Construct a meaningful title key from the list
                title_parts = section_info.get('title', [f'未知章节 {i+1}'])  # Default title if missing
                title_key = " - ".join(title_parts)  # Join title parts with " - "

                # 将段落列表拼接为一个字符串
                content = " ".join(section_info.get('paragraph', []))  # Join all paragraphs into a single string
                # --- Modification End ---

                print(f"  处理章节 {i+1}/{len(document_data)}: {title_key}")

                if not content or content.isspace():
                    print(f"  警告: 章节 '{title_key}' 内容为空，跳过。")
                    continue  # Skip this section if content is empty

                summary = self.generate_section_summary(content)

                if summary is not None:  # Check if summary generation was successful
                    section_summaries[title_key] = summary
                    all_section_texts_for_overall.append(summary)  # Use section summary for overall summary

                    section_info['summary'] = summary
                    section_info['id'] = i
                else:
                    print(f"  警告: 章节 '{title_key}' 摘要生成失败，将跳过此章节。")

            if not section_summaries:
                print("错误：所有章节摘要均生成失败。")
                return None

            # Combine successful section summaries to generate the overall summary
            print("\n开始生成整体摘要...")
            combined_summary_text = "\n\n".join(all_section_texts_for_overall)

            # Check if combined text is empty (might happen if all summaries were empty strings)
            if not combined_summary_text or combined_summary_text.isspace():
                print("警告：没有可用于生成整体摘要的内容。")
                overall_summary = "未能生成整体摘要，因为没有成功的章节摘要或摘要内容为空。"
            else:
                # Reuse generate_section_summary logic for the overall summary
                overall_summary = self.generate_section_summary(combined_summary_text)
                if overall_summary is None:
                    print("错误：生成整体摘要失败。")
                    overall_summary = "生成整体摘要时出错。"  # Provide an error message

            print("摘要生成完成。")
            return {
                "section_summaries": document_data,
                "overall_summary": overall_summary
            }

        except Exception as e:
            print(f"生成文档摘要时发生严重错误: {str(e)}")
            return None





if __name__ == '__main__':
    # data = [{'title': '目  录', 'paragraphs': [], 'children': []}, {'title': '一、预算编制说明\t1', 'paragraphs': [], 'children': []}, {'title': '1、项目概况\t1', 'paragraphs': [], 'children': []}, {'title': '2、预算编制依据\t5', 'paragraphs': [], 'children': []}, {'title': '3、选取定额标准和计算方法\t6', 'paragraphs': [], 'children': []}, {'title': '4、项目预算的合理性及可靠性分析\t11', 'paragraphs': [], 'children': []}, {'title': '5、其它需要说明的问题\t11', 'paragraphs': [], 'children': []}, {'title': '二、预算表\t13', 'paragraphs': [], 'children': []}, {'title': '一、预算编制说明', 'paragraphs': [], 'children': [{'title': '1、项目概况', 'paragraphs': ['“内蒙古四子王旗小南山一带铜镍多金属矿区块优选调查评价”系2025年度内蒙古自治区财政出资地质勘查项目。资金来源为内蒙古自治区财政专项资金，出资比例为100%。招标人内蒙古自治区测绘地理信息中心以公开招标方式优选勘查单位，委托内蒙古自治区公共资源交易中心在内蒙古自治区公共资源交易平台（内蒙古自治区自然资源网上交易系统）上实施招投标活动；招标代理机构是内蒙古亿和全过程工程项目管理有限公司。我单位就此项目进行了认真的资料收集、综合研究、实地踏勘和标书编写。', '项目名称：内蒙古四子王旗小南山一带铜镍多金属矿区块优选调查评价', '项目编号：2025-JC09', '任务书编号：[2025]基础-09', '招标编号：CHDL-2025-2-89', '工作起止年限：2025年1月—2029年1月', '资料汇交时间：2029年1月', '概算经费：1211万元', '（1）工作区位置及地理坐标', '调查区位于内蒙古自治区中西，行政区划隶属乌兰察布市四子王旗、包头市达尔罕茂明安联合旗（西南角）管辖。东南距四子王旗政府所在地乌兰花镇约30km，西距达尔罕茂明安联合旗政府所在地百灵庙镇约55km。', '工作区范围(2000国家大地坐标系)：', '111°08′19″，41°43′49″；', '111°08′19″，41°57′01″；', '111°37′47″，41°57′01″；', '111°37′47″，41°46′22″；', '111°29′57″，41°43′49″；', '涉及1∶5万国际标准图幅6幅：小白林地幅（K49E013013）、白林地幅（K49E014013）、打忽拉幅（K49E013014）、大井坡幅（K49E014014）、后点力素呼洞幅（K49E013015）、西海卜子幅（K49E014015）。', '面积：面积971km2。', '依据财政部、国土资源部印发的《地区调整系数图册》（《国土资源调查预算标准》地质调查部分)（财建[2007]52号）中的地区调整系数判定条件确定该区的地区调整系数为1.2。', '（2）工作区地形、地貌', '调查区位于内蒙古高原中西部，属达茂旗-四子王旗草原区，地形总体较为平坦，山脉呈北东-北东东向延伸，地势总体南高北低、东高西低。海拔标高1324～1600m，绝对高差276m，平均相对高差30～100m，坡度小于10°。调查区及周边地表水系较不发育，除东部希拉木伦高勒塔布河外，无常年流水，仅雨季有间歇性洪流。区域植被较发育，除大面积牧场外，可见小规模林地、农地。区域交通以公路为主，主要居民点有简易道路与之相连，可通行越野车，工作区整体交通较为便利。', '根据中国地质调查局《地质调查项目预算标准》（2010年试用）中的物化探工作地形要素划分标准及分值表：该区平均高差30～100m之间5分；区内交通较为便利，大部分的测点可步行到达3分；测区内植被发育，多为优质高产牧草平均视距达到100～200米3分；坡度小于10°7分；合计分值为18分，所以确定该区地形等级为Ⅱ级。', '依据《中国地震动参数区划图》（GB18306-2015），本区Ⅱ类场地地震动峰值加速度为0.05g，对照地震烈度为Ⅵ度。区内无滑坡、崩塌、泥石流、塌陷、地裂缝、地面沉降等不良地质作用及地质灾害发生的记录。', '（3）工作区地质概况', '依据《中国区域地质志·内蒙古志》（2020），调查区构造单元属华北板块→华北陆块→华北陆块北缘隆起带→白云鄂博裂谷。出露地层主要有中新元古界白云鄂博群（Pt2-3B），中生界侏罗系大青山组（J3d），新生界新近系宝格达乌拉组(N2b)，以及第四系(Q)。岩浆岩主要有晚志留世斜长花岗岩（S3γ）、石炭纪辉长岩（Cυ）、中二叠世钾长花岗岩（P2ξγ）、中二叠世二长花岗岩（P2ηγ）及花岗斑岩脉（γπ）等各类脉岩。区内主构造线呈北东向，构造格局主要表现为北东向主断裂、北东向展布的白云鄂博群和岩浆岩带发育。褶皱形态因地层出露差、岩体或断裂破坏而变得不完整；韧性剪切带规模较小，多见于白云鄂博群，以近东西向为主；断裂以北东向、北东东向断裂为主，北西向、近南北向断裂较少，断裂性质因构造环境的差异而有不同的表现，以逆断层为主（压扭性），其中部分北东向、北东东向断裂具多期活动特点；新构造运动主要表现为地壳的总体抬升和差异性升降。', '根据中国地质调查局《地质调查项目预算标准》（2010年试用）中的地质复杂程度分类特征：该区白云鄂博群出露广泛，东部、西北部新生界覆盖严重，出露岩浆岩以中粗粒、中细粒花岗岩类为主，岩石完整，裂隙不发育，岩石露头风化破碎严重；区域变质作用较明显，变质岩较发育，地形地貌起伏变化；区内构造较发育，以断裂为主。综合确定该区地质复杂程度为中常区。', '本区出露地层的岩性主要是灰岩、变质石英砂岩、板岩，根据西部白云鄂博矿区钻探施工经验，该区岩石硬度适中。根据中国地质调查局《地质调查项目预算标准》（2010年试用）中的岩石级别判定标准，该区大部分岩石级别属Ⅷ级，所以本次预算岩石级别取Ⅷ级。', '遥感地质解译971km2，虽然有第四系和植被覆盖，影响清晰，但整体上地质解译标志明显，可解译出区内的构造轮廓和部分地质体之间的接触关系。根据中国地质调查局《地质调查项目预算标准》（2010年试用）中的遥感地质解译航卫片可解程度分类标准，确定遥感地质可解程度为Ⅱ（中常）。', '（4）年度工作任务', '目标任务：', '在充分收集、分析研究前人资料的基础上,以寻找铜镍等紧缺战略性矿产为重点,兼顾优势战略性矿产和其他重要矿种。以先进的地质成矿理论为指导,通过遥感地质解译及成矿信息提取、矿产地质填图、地球物理测量、地球化学测量、工程揭露验证等方法,大致查明调查评价区成矿地质条件、矿体地质特征、矿石质量、技术经济条件和环境影响因素等,总结成矿规律,评价矿产资源潜力,圈定找矿靶区、优选勘查区块,为矿产资源勘查提供基础地质信息和资料。', '主要实物工作量：', '预期成果：', '（1）提交《内蒙古四子王旗小南山一带铜镍多金属矿区块优选调查评价报告》及相应的附图、附表、附件、电子数据光盘。', '（2）提交可供进一步工作的勘查区块2～3处。'], 'children': []}, {'title': '2、预算编制依据', 'paragraphs': ['（1）2025年度内蒙古自治区财政出资地质勘查项目（第二阶段）招标文件，任务书编号：[2025]基础-09，招标编号：CHDL-2025-2-89。', '（2）内蒙古自治区测绘地理信息中心财政出资地质勘查项目“内蒙古四子王旗小南山一带铜镍多金属矿区块优选调查评价”招标任务书。', '（3）《内蒙古四子王旗小南山一带铜镍多金属矿区块优选调查评价技术投标方案》，方案依据招标文件确定了工作量。', '（4）《内蒙古自治区本级项目支出预算管理办法》内政办发〔2016〕136号；', '（5）《内蒙古自治区地质勘查项目和资金管理暂行办法》（内自然资发〔2023〕77号）', '（6）财政部、国土资源部印发的《地区调整系数图册》（《国土资源调查预算标准》地质调查部分)（财建[2007]52号）；', '（7）中国地质调查局《地质调查项目预算标准》（2010年试用）。'], 'children': []}, {'title': '3、选取定额标准和计算方法', 'paragraphs': ['依据内蒙古自治区自然资源厅、财政厅经费概算编制要求，本项目属于矿产资源评价类项目，按照甲类预算表进行预算编制。', '项目经费设计预算由地质勘查项目设计预算汇总表(甲类)“预算甲—1表”、地质勘查项目设计预算表(甲类)“预算甲—2表”组成。预算编制方法如下：', '（1）地质勘查项目设计预算汇总表“预算甲—1表”的编制方法：', '各工作项目的总预算取值于地质勘查项目设计预算表，项目预算总计由各工作项目总预算相加求得。工作项目共分地形测绘、地质测量、物探、化探、遥感、海洋地质调查、钻探、坑探、浅井、槽探、岩矿测试、其他地质工作、工地建筑、税金十四项。', '（2）地质勘查项目设计预算表“预算甲—2表”的编制方法：', '预算编制时按下列技术条件确定费用标准：', '①工区地区调整系数为1.2；', '②地质测量的复杂程度为中常区；', '③物化探测量的地形等级为Ⅱ级；', '④钻探岩石级别为Ⅷ级；', '⑤槽探为0～3m土石方；', '⑥遥感地质可解程度为Ⅱ（中常）。', '根据《内蒙古四子王旗小南山一带铜镍多金属矿区块优选调查评价技术投标方案》中的工作项目分别填列工作量，根据所确定的技术条件和工作项目名称选择预算标准，按表中所设计的计算公式计算各项工作费用，计算公式为：', '单位预算标准＝地质调查项目预算标准×地区系数', '预算费用＝单位预算标准×工作量', '在计算单位预算标准时，野外作业采用地质调查项目预算标准×地区系数，室内及岩矿实验等未使用地区调整系数。例如（主要实物工作量）：', '1∶25000专项地质填图240km2，地质复杂程度为中常区，地区调整系数1.2。', '单位预算标准为1569×1.2=1882.80元/km2；', '预算费用=1882.80×240÷10000=45.19(万元)。', '1∶10000地质剖面测量20km，地质复杂程度为中常区，地区调整系数1.2。', '单位预算标准为1566×1.2=1879.20元/km；', '预算费用=1879.20×20÷10000=3.76(万元)。', '1∶25000磁法测量500km2，网度250×50m，地形等级为Ⅱ级，地区调整系数1.2。', '单位预算标准为1893×1.2=2379.60元/km；', '预算费用=2379.60.×500÷10000=118.98(万元)。', '1∶10000磁法剖面测量20km，点距40m，地形等级为Ⅱ级，地区调整系数1.2。', '单位预算标准为764×1.2=916.80元/km；', '预算费用=916.80×20÷10000=1.83(万元)。', '1∶25000重力测量300km2，网度250×50m，地形等级为Ⅱ级，地区调整系数1.2。', '单位预算标准为5280×1.2=6336.00元/km；', '预算费用=6336.00×300÷10000=190.80(万元)。', '1∶10000重力剖面测量20km，点距40m，地形等级为Ⅱ级，地区调整系数1.2。', '单位预算标准为2198×1.2=2637.60元/km；', '预算费用=2637.60×20÷10000=5.28(万元)。', '1∶25000激电中梯测量30km2，网度100×40m，地形等级为Ⅱ级，地区调整系数1.2。', '单位预算标准为19093×1.2=22911.60元/km；', '预算费用=22911.60×30÷10000=68.73(万元)。', '激电中梯（短导线）剖面测量20km，点距40m，地形等级为Ⅱ级，地区调整系数1.2。', '单位预算标准为2259×1.2=2710.80元/km；', '预算费用=2710.80×20÷10000=5.42(万元)。', '激电中测深50点，AB距4000m，地形等级为Ⅱ级，地区调整系数1.2。', '单位预算标准为2203×1.2=2643.60元/km；', '预算费用=2643.60×50÷10000=13.22(万元)。', '广域大地电磁测深260点，点距≤50m，地形等级为Ⅱ级，地区调整系数1.2。', '单位预算标准为1837×1.2=2204.40元/km；', '预算费用=2204.40×260÷10000=57.31(万元)。', '1∶25000土壤测量240km2，自由网,密度为40点/km2,地形等级为Ⅱ级，地区调整系数1.2。', '单位预算标准为818×62%×1.2=608.59元/km2；', '预算费用=608.59×240÷10000=14.61(万元）。', '1∶10000土壤剖面测量20km，点距40m，地形等级为Ⅱ级，地区调整系数1.2。', '单位预算标准为268×1.2=321.60元/km；', '预算费用=321.60×20÷10000=0.64（万元)。', '1∶25000遥感地质解译及蚀变信息提取971km2，可解程度Ⅱ。', '单位预算标准为2.2+232=234.20元/km2；', '预算费用=234.20×971÷10000=22.74（万元)。', '钻探2000m,孔深0～400m岩石级别Ⅷ级，地区调整系数1.2。', '单位预算标准为1027×1.2=1202.40元/m；', '预算费用=1202.40×2000÷10000=240.48（万元）。', '槽探1000m3,0～3m土石方，地区调整系数1.2。', '单位预算标准为110×1.2=132.00元/m3；', '预算费用=132×2000÷10000=26.40（万元）。', '室内工作项目预算费用公式为：预算费用＝地质调查单位预算标准×工作量。一般岩矿分析以样为单位的按单项试验项目的单价之和作为单位预算标准。例如：', '基本分析样350件5种元素合计单价229.00元/件，其综合计算情况如下：', '预算费用=229×350÷10000=8.02（万元）。', '土壤样10000件、基岩光谱样400件15种元素合计单价128.00元/件，其综合计算情况如下：', '土壤样预算费用=128.00×10000÷10000=128.00万元）。', '基岩光谱样预算费用=128.00×400÷10000=5.12（万元）。', '物相分析样3件（铁物相、铜物相、镍物相各一件）。', '预算费用=（371+553+421）÷10000=0.13（万元）。', '稀土分量、硅酸盐分析、微量分析50件。', '单位预算标准为314+450+723=1487.00元/件；', '预算费用=1487.00×50÷10000=7.44（万元）。', '电子探针300点，单位预算标准为287元/点。', '预算费用=287.00×300÷10000=8.61（万元）。', '同位素测年（锆石U-Pb）500点，单位预算标准1000.00元/点。', '预算费用=1000.00×500÷10000=50.00（万元）。', '同位素（S）10件，单位预算标准96.00元/件。', '预算费用=96.00×10÷10000=0.10（万元）。', '同位素（Hf）10件，单位预算标准344.00元/件(参照同位素氧)。', '预算费用=344.00×10÷10000=0.34（万元）。', '同位素（氢氧）10件，单位预算标准229+344=573.00元/件。', '预算费用=573.00×10÷10000=0.57（万元）。', '其他地质工作：', '工程点测量5个点，地区调整系数1.2。', '单位预算标准为1600×1.2=1920.00元/点；', '预算费用=1920.00×5÷10000=0.96（万元）。', '钻探地质编录：矿产地质钻探2000m,地区调整系数1.2。', '单位预算标准=20×1.2=24.00元/m', '预算费用=24.00×2000÷10000=4.80（万元）。', '岩心样采样：按延长米170m计算，地区调整系数1.2。', '单位预算标准=20×1.2=24.00元/m', '预算费用=24.00×170÷10000=0.41（万元）。', '岩矿心保管：按钻探总长的85%计算，地区调整系数1.2。', '单位预算标准=15×1.2=18.00元/m', '预算费用=18.00×2000×85%÷10000=3.06（万元）。', '设计论证编写的单位预算标准：60000.00元/份', '综合研究及编写报告的单位预算标准：180000.00元/份（总经费＞1000万元）', '报告印刷的单位预算标准：60000.00元/份', '本项目属于矿产资源调查评价类项目，工地建筑按照野外工作费用之和的7.66%计算，工地建筑费为62.51万元。'], 'children': []}, {'title': '4、项目预算的合理性及可靠性分析', 'paragraphs': ['“内蒙古四子王旗小南山一带铜镍多金属矿区块优选调查评价”为矿产资源类项目，该项目根据中国地质调查局《地质调查项目预算标准》（2010年试用）和技术投标方案进行预算编制，选择了正确的地区调整系数，根据技术条件确定了合适的定额标准，准确反映了各工作手段的困难类别、地质复杂程度、地形等级、岩石级别及岩矿试验分析项目等。', '本次概算的总费用是1211.00万元，2025年度概算经费为627.39万元，占总预算的51.81%；2026年度概算经费为227.95万元，占总预算的18.82%；2027年度概算经费为330.22万元，占总预算的27.27%；2028年度概算经费为25.44万元，占总预算的2.10%。其中地质测量48.95万元，占总预算的4.04%；物探460.86万元，占总预算的38.06%；化探27.27万元，占总预算的2.25%；遥感22.74万元，占总预算的1.88%；钻探240.48万元，占总预算的19.86%；槽探26.40万元，占总预算的2.18%；岩矿测试211.53万元，占总预算的17.47%；其它地质工作41.72万元，占总预算的3.45%；工地建筑62.51万元，占总预算的5.16%；税金68.55万元，占总预算5.66%。从经济角度看，经费预算部署恰当，依据充分，各工作手段占用资金比例分配合理，能够保证本次勘查工作目标任务的实现。', '本次工作利用1∶2.5万地质填图、1∶1万地质、磁法、土壤、激电、重力综合剖面物探、化探、遥感、钻探、槽探和岩矿试验综合勘查工作手段，结合勘查区以往地质资料分析，从技术角度看本次工作量适宜，可以完成招标文件下达的目标任务，从而达到预期成果。'], 'children': []}, {'title': '5、其它需要说明的问题', 'paragraphs': ['（1）税金：按照工作总经费的6%计算。', '税金=（各项工作手段预算费用之和+工地建筑预算费用）×6%=68.55万元。', '（2）1∶2.5万土壤测量自由网、密度为40点/km2，Ⅱ级地形的土壤测量标准的确定：因为网度为100×20米、Ⅱ级地形的土壤测量标准为4097元/km2，网度为100×40米、Ⅱ级地形的土壤测量标准为2540元/km2，点距放大一倍（即采样密度降低一半），标准降低38%。同理，自由网、密度为40点/km2、Ⅱ级地形的土壤测量标准应在网度为250×50米（即采样密度为80点/km）Ⅱ级地形的土壤测量标准为818元/km2的62%，即507.16元/km2。', '（3）1∶2.5万土壤测量因采用自由网，不能进行测网布设，但需要用手持GPS进行确定采样点位，这样会增加设备使用成本，同时也会降低生产效率，故按网度为250×50米（即采样密度为80点/km2）、Ⅱ级地形的土壤测量标准818元/km2的20%考虑，即163.60元/km2。', '（4）预算编制过程中广域大地电磁测深在中国地质调查局《地质调查项目预算标准》（2010年试用）中没有对应的定额标准，本次预算参照山东省地质调查预算标准（鲁财资环〔2020〕30号）中对应工作手段预算标准计算。', '（5）预算编制过程中微量分析在中国地质调查局《地质调查项目预算标准》（2010年试用）中没有对应的定额标准，本次预算参照中国地质调查局《地质调查项目预算标准》（2021年）中微量稀土分析预算标注723元/件计算。'], 'children': []}]}, {'title': '二、预算表', 'paragraphs': ['“内蒙古四子王旗小南山一带铜镍多金属矿区块优选调查评价”项目概算经费为1211.00万元，由《地质勘查项目设计预算汇总表（甲类）》“预算甲—1表”和《地质勘查项目设计预算表（甲类）》“预算甲—2表”构成。'], 'children': []}]
    data = [{'title': '目  录', 'paragraphs': [], 'children': []}, {'title': '一、预算编制说明\t1', 'paragraphs': [], 'children': []}, {'title': '1、项目概况\t1', 'paragraphs': [], 'children': []}, {'title': '2、预算编制依据\t5', 'paragraphs': [], 'children': []}, {'title': '3、选取定额标准和计算方法\t6', 'paragraphs': [], 'children': []}, {'title': '4、项目预算的合理性及可靠性分析\t11', 'paragraphs': [], 'children': []}, {'title': '5、其它需要说明的问题\t11', 'paragraphs': [], 'children': []}, {'title': '二、预算表\t13', 'paragraphs': [], 'children': []}, {'title': '一、预算编制说明', 'paragraphs': [], 'children': [{'title': '1、项目概况', 'paragraphs': ['“内蒙古四子王旗小南山一带铜镍多金属矿区块优选调查评价”系2025年度内蒙古自治区财政出资地质勘查项目。资金来源为内蒙古自治区财政专项资金，出资比例为100%。招标人内蒙古自治区测绘地理信息中心以公开招标方式优选勘查单位，委托内蒙古自治区公共资源交易中心在内蒙古自治区公共资源交易平台（内蒙古自治区自然资源网上交易系统）上实施招投标活动；招标代理机构是内蒙古亿和全过程工程项目管理有限公司。我单位就此项目进行了认真的资料收集、综合研究、实地踏勘和标书编写。', '项目名称：内蒙古四子王旗小南山一带铜镍多金属矿区块优选调查评价', '项目编号：2025-JC09', '任务书编号：[2025]基础-09', '招标编号：CHDL-2025-2-89', '工作起止年限：2025年1月—2029年1月', '资料汇交时间：2029年1月', '概算经费：1211万元', '（1）工作区位置及地理坐标', '调查区位于内蒙古自治区中西，行政区划隶属乌兰察布市四子王旗、包头市达尔罕茂明安联合旗（西南角）管辖。东南距四子王旗政府所在地乌兰花镇约30km，西距达尔罕茂明安联合旗政府所在地百灵庙镇约55km。', '工作区范围(2000国家大地坐标系)：', '111°08′19″，41°43′49″；', '111°08′19″，41°57′01″；', '111°37′47″，41°57′01″；', '111°37′47″，41°46′22″；', '111°29′57″，41°43′49″；', '涉及1∶5万国际标准图幅6幅：小白林地幅（K49E013013）、白林地幅（K49E014013）、打忽拉幅（K49E013014）、大井坡幅（K49E014014）、后点力素呼洞幅（K49E013015）、西海卜子幅（K49E014015）。', '面积：面积971km2。', '依据财政部、国土资源部印发的《地区调整系数图册》（《国土资源调查预算标准》地质调查部分)（财建[2007]52号）中的地区调整系数判定条件确定该区的地区调整系数为1.2。', '（2）工作区地形、地貌', '调查区位于内蒙古高原中西部，属达茂旗-四子王旗草原区，地形总体较为平坦，山脉呈北东-北东东向延伸，地势总体南高北低、东高西低。海拔标高1324～1600m，绝对高差276m，平均相对高差30～100m，坡度小于10°。调查区及周边地表水系较不发育，除东部希拉木伦高勒塔布河外，无常年流水，仅雨季有间歇性洪流。区域植被较发育，除大面积牧场外，可见小规模林地、农地。区域交通以公路为主，主要居民点有简易道路与之相连，可通行越野车，工作区整体交通较为便利。', '根据中国地质调查局《地质调查项目预算标准》（2010年试用）中的物化探工作地形要素划分标准及分值表：该区平均高差30～100m之间5分；区内交通较为便利，大部分的测点可步行到达3分；测区内植被发育，多为优质高产牧草平均视距达到100～200米3分；坡度小于10°7分；合计分值为18分，所以确定该区地形等级为Ⅱ级。', '依据《中国地震动参数区划图》（GB18306-2015），本区Ⅱ类场地地震动峰值加速度为0.05g，对照地震烈度为Ⅵ度。区内无滑坡、崩塌、泥石流、塌陷、地裂缝、地面沉降等不良地质作用及地质灾害发生的记录。', '（3）工作区地质概况', '依据《中国区域地质志·内蒙古志》（2020），调查区构造单元属华北板块→华北陆块→华北陆块北缘隆起带→白云鄂博裂谷。出露地层主要有中新元古界白云鄂博群（Pt2-3B），中生界侏罗系大青山组（J3d），新生界新近系宝格达乌拉组(N2b)，以及第四系(Q)。岩浆岩主要有晚志留世斜长花岗岩（S3γ）、石炭纪辉长岩（Cυ）、中二叠世钾长花岗岩（P2ξγ）、中二叠世二长花岗岩（P2ηγ）及花岗斑岩脉（γπ）等各类脉岩。区内主构造线呈北东向，构造格局主要表现为北东向主断裂、北东向展布的白云鄂博群和岩浆岩带发育。褶皱形态因地层出露差、岩体或断裂破坏而变得不完整；韧性剪切带规模较小，多见于白云鄂博群，以近东西向为主；断裂以北东向、北东东向断裂为主，北西向、近南北向断裂较少，断裂性质因构造环境的差异而有不同的表现，以逆断层为主（压扭性），其中部分北东向、北东东向断裂具多期活动特点；新构造运动主要表现为地壳的总体抬升和差异性升降。', '根据中国地质调查局《地质调查项目预算标准》（2010年试用）中的地质复杂程度分类特征：该区白云鄂博群出露广泛，东部、西北部新生界覆盖严重，出露岩浆岩以中粗粒、中细粒花岗岩类为主，岩石完整，裂隙不发育，岩石露头风化破碎严重；区域变质作用较明显，变质岩较发育，地形地貌起伏变化；区内构造较发育，以断裂为主。综合确定该区地质复杂程度为中常区。', '本区出露地层的岩性主要是灰岩、变质石英砂岩、板岩，根据西部白云鄂博矿区钻探施工经验，该区岩石硬度适中。根据中国地质调查局《地质调查项目预算标准》（2010年试用）中的岩石级别判定标准，该区大部分岩石级别属Ⅷ级，所以本次预算岩石级别取Ⅷ级。', '遥感地质解译971km2，虽然有第四系和植被覆盖，影响清晰，但整体上地质解译标志明显，可解译出区内的构造轮廓和部分地质体之间的接触关系。根据中国地质调查局《地质调查项目预算标准》（2010年试用）中的遥感地质解译航卫片可解程度分类标准，确定遥感地质可解程度为Ⅱ（中常）。', '（4）年度工作任务', '目标任务：', '在充分收集、分析研究前人资料的基础上,以寻找铜镍等紧缺战略性矿产为重点,兼顾优势战略性矿产和其他重要矿种。以先进的地质成矿理论为指导,通过遥感地质解译及成矿信息提取、矿产地质填图、地球物理测量、地球化学测量、工程揭露验证等方法,大致查明调查评价区成矿地质条件、矿体地质特征、矿石质量、技术经济条件和环境影响因素等,总结成矿规律,评价矿产资源潜力,圈定找矿靶区、优选勘查区块,为矿产资源勘查提供基础地质信息和资料。', '主要实物工作量：', '预期成果：', '（1）提交《内蒙古四子王旗小南山一带铜镍多金属矿区块优选调查评价报告》及相应的附图、附表、附件、电子数据光盘。', '（2）提交可供进一步工作的勘查区块2～3处。'], 'children': []}, {'title': '2、预算编制依据', 'paragraphs': ['（1）2025年度内蒙古自治区财政出资地质勘查项目（第二阶段）招标文件，任务书编号：[2025]基础-09，招标编号：CHDL-2025-2-89。', '（2）内蒙古自治区测绘地理信息中心财政出资地质勘查项目“内蒙古四子王旗小南山一带铜镍多金属矿区块优选调查评价”招标任务书。', '（3）《内蒙古四子王旗小南山一带铜镍多金属矿区块优选调查评价技术投标方案》，方案依据招标文件确定了工作量。', '（4）《内蒙古自治区本级项目支出预算管理办法》内政办发〔2016〕136号；', '（5）《内蒙古自治区地质勘查项目和资金管理暂行办法》（内自然资发〔2023〕77号）', '（6）财政部、国土资源部印发的《地区调整系数图册》（《国土资源调查预算标准》地质调查部分)（财建[2007]52号）；', '（7）中国地质调查局《地质调查项目预算标准》（2010年试用）。'], 'children': []}, {'title': '3、选取定额标准和计算方法', 'paragraphs': ['依据内蒙古自治区自然资源厅、财政厅经费概算编制要求，本项目属于矿产资源评价类项目，按照甲类预算表进行预算编制。', '项目经费设计预算由地质勘查项目设计预算汇总表(甲类)“预算甲—1表”、地质勘查项目设计预算表(甲类)“预算甲—2表”组成。预算编制方法如下：', '（1）地质勘查项目设计预算汇总表“预算甲—1表”的编制方法：', '各工作项目的总预算取值于地质勘查项目设计预算表，项目预算总计由各工作项目总预算相加求得。工作项目共分地形测绘、地质测量、物探、化探、遥感、海洋地质调查、钻探、坑探、浅井、槽探、岩矿测试、其他地质工作、工地建筑、税金十四项。', '（2）地质勘查项目设计预算表“预算甲—2表”的编制方法：', '预算编制时按下列技术条件确定费用标准：', '①工区地区调整系数为1.2；', '②地质测量的复杂程度为中常区；', '③物化探测量的地形等级为Ⅱ级；', '④钻探岩石级别为Ⅷ级；', '⑤槽探为0～3m土石方；', '⑥遥感地质可解程度为Ⅱ（中常）。', '根据《内蒙古四子王旗小南山一带铜镍多金属矿区块优选调查评价技术投标方案》中的工作项目分别填列工作量，根据所确定的技术条件和工作项目名称选择预算标准，按表中所设计的计算公式计算各项工作费用，计算公式为：', '单位预算标准＝地质调查项目预算标准×地区系数', '预算费用＝单位预算标准×工作量', '在计算单位预算标准时，野外作业采用地质调查项目预算标准×地区系数，室内及岩矿实验等未使用地区调整系数。例如（主要实物工作量）：', '1∶25000专项地质填图240km2，地质复杂程度为中常区，地区调整系数1.2。', '单位预算标准为1569×1.2=1882.80元/km2；', '预算费用=1882.80×240÷10000=45.19(万元)。', '1∶10000地质剖面测量20km，地质复杂程度为中常区，地区调整系数1.2。', '单位预算标准为1566×1.2=1879.20元/km；', '预算费用=1879.20×20÷10000=3.76(万元)。', '1∶25000磁法测量500km2，网度250×50m，地形等级为Ⅱ级，地区调整系数1.2。', '单位预算标准为1893×1.2=2379.60元/km；', '预算费用=2379.60.×500÷10000=118.98(万元)。', '1∶10000磁法剖面测量20km，点距40m，地形等级为Ⅱ级，地区调整系数1.2。', '单位预算标准为764×1.2=916.80元/km；', '预算费用=916.80×20÷10000=1.83(万元)。', '1∶25000重力测量300km2，网度250×50m，地形等级为Ⅱ级，地区调整系数1.2。', '单位预算标准为5280×1.2=6336.00元/km；', '预算费用=6336.00×300÷10000=190.80(万元)。', '1∶10000重力剖面测量20km，点距40m，地形等级为Ⅱ级，地区调整系数1.2。', '单位预算标准为2198×1.2=2637.60元/km；', '预算费用=2637.60×20÷10000=5.28(万元)。', '1∶25000激电中梯测量30km2，网度100×40m，地形等级为Ⅱ级，地区调整系数1.2。', '单位预算标准为19093×1.2=22911.60元/km；', '预算费用=22911.60×30÷10000=68.73(万元)。', '激电中梯（短导线）剖面测量20km，点距40m，地形等级为Ⅱ级，地区调整系数1.2。', '单位预算标准为2259×1.2=2710.80元/km；', '预算费用=2710.80×20÷10000=5.42(万元)。', '激电中测深50点，AB距4000m，地形等级为Ⅱ级，地区调整系数1.2。', '单位预算标准为2203×1.2=2643.60元/km；', '预算费用=2643.60×50÷10000=13.22(万元)。', '广域大地电磁测深260点，点距≤50m，地形等级为Ⅱ级，地区调整系数1.2。', '单位预算标准为1837×1.2=2204.40元/km；', '预算费用=2204.40×260÷10000=57.31(万元)。', '1∶25000土壤测量240km2，自由网,密度为40点/km2,地形等级为Ⅱ级，地区调整系数1.2。', '单位预算标准为818×62%×1.2=608.59元/km2；', '预算费用=608.59×240÷10000=14.61(万元）。', '1∶10000土壤剖面测量20km，点距40m，地形等级为Ⅱ级，地区调整系数1.2。', '单位预算标准为268×1.2=321.60元/km；', '预算费用=321.60×20÷10000=0.64（万元)。', '1∶25000遥感地质解译及蚀变信息提取971km2，可解程度Ⅱ。', '单位预算标准为2.2+232=234.20元/km2；', '预算费用=234.20×971÷10000=22.74（万元)。', '钻探2000m,孔深0～400m岩石级别Ⅷ级，地区调整系数1.2。', '单位预算标准为1027×1.2=1202.40元/m；', '预算费用=1202.40×2000÷10000=240.48（万元）。', '槽探1000m3,0～3m土石方，地区调整系数1.2。', '单位预算标准为110×1.2=132.00元/m3；', '预算费用=132×2000÷10000=26.40（万元）。', '室内工作项目预算费用公式为：预算费用＝地质调查单位预算标准×工作量。一般岩矿分析以样为单位的按单项试验项目的单价之和作为单位预算标准。例如：', '基本分析样350件5种元素合计单价229.00元/件，其综合计算情况如下：', '预算费用=229×350÷10000=8.02（万元）。', '土壤样10000件、基岩光谱样400件15种元素合计单价128.00元/件，其综合计算情况如下：', '土壤样预算费用=128.00×10000÷10000=128.00万元）。', '基岩光谱样预算费用=128.00×400÷10000=5.12（万元）。', '物相分析样3件（铁物相、铜物相、镍物相各一件）。', '预算费用=（371+553+421）÷10000=0.13（万元）。', '稀土分量、硅酸盐分析、微量分析50件。', '单位预算标准为314+450+723=1487.00元/件；', '预算费用=1487.00×50÷10000=7.44（万元）。', '电子探针300点，单位预算标准为287元/点。', '预算费用=287.00×300÷10000=8.61（万元）。', '同位素测年（锆石U-Pb）500点，单位预算标准1000.00元/点。', '预算费用=1000.00×500÷10000=50.00（万元）。', '同位素（S）10件，单位预算标准96.00元/件。', '预算费用=96.00×10÷10000=0.10（万元）。', '同位素（Hf）10件，单位预算标准344.00元/件(参照同位素氧)。', '预算费用=344.00×10÷10000=0.34（万元）。', '同位素（氢氧）10件，单位预算标准229+344=573.00元/件。', '预算费用=573.00×10÷10000=0.57（万元）。', '其他地质工作：', '工程点测量5个点，地区调整系数1.2。', '单位预算标准为1600×1.2=1920.00元/点；', '预算费用=1920.00×5÷10000=0.96（万元）。', '钻探地质编录：矿产地质钻探2000m,地区调整系数1.2。', '单位预算标准=20×1.2=24.00元/m', '预算费用=24.00×2000÷10000=4.80（万元）。', '岩心样采样：按延长米170m计算，地区调整系数1.2。', '单位预算标准=20×1.2=24.00元/m', '预算费用=24.00×170÷10000=0.41（万元）。', '岩矿心保管：按钻探总长的85%计算，地区调整系数1.2。', '单位预算标准=15×1.2=18.00元/m', '预算费用=18.00×2000×85%÷10000=3.06（万元）。', '设计论证编写的单位预算标准：60000.00元/份', '综合研究及编写报告的单位预算标准：180000.00元/份（总经费＞1000万元）', '报告印刷的单位预算标准：60000.00元/份', '本项目属于矿产资源调查评价类项目，工地建筑按照野外工作费用之和的7.66%计算，工地建筑费为62.51万元。'], 'children': []}, {'title': '4、项目预算的合理性及可靠性分析', 'paragraphs': ['“内蒙古四子王旗小南山一带铜镍多金属矿区块优选调查评价”为矿产资源类项目，该项目根据中国地质调查局《地质调查项目预算标准》（2010年试用）和技术投标方案进行预算编制，选择了正确的地区调整系数，根据技术条件确定了合适的定额标准，准确反映了各工作手段的困难类别、地质复杂程度、地形等级、岩石级别及岩矿试验分析项目等。', '本次概算的总费用是1211.00万元，2025年度概算经费为627.39万元，占总预算的51.81%；2026年度概算经费为227.95万元，占总预算的18.82%；2027年度概算经费为330.22万元，占总预算的27.27%；2028年度概算经费为25.44万元，占总预算的2.10%。其中地质测量48.95万元，占总预算的4.04%；物探460.86万元，占总预算的38.06%；化探27.27万元，占总预算的2.25%；遥感22.74万元，占总预算的1.88%；钻探240.48万元，占总预算的19.86%；槽探26.40万元，占总预算的2.18%；岩矿测试211.53万元，占总预算的17.47%；其它地质工作41.72万元，占总预算的3.45%；工地建筑62.51万元，占总预算的5.16%；税金68.55万元，占总预算5.66%。从经济角度看，经费预算部署恰当，依据充分，各工作手段占用资金比例分配合理，能够保证本次勘查工作目标任务的实现。', '本次工作利用1∶2.5万地质填图、1∶1万地质、磁法、土壤、激电、重力综合剖面物探、化探、遥感、钻探、槽探和岩矿试验综合勘查工作手段，结合勘查区以往地质资料分析，从技术角度看本次工作量适宜，可以完成招标文件下达的目标任务，从而达到预期成果。'], 'children': []}, {'title': '5、其它需要说明的问题', 'paragraphs': ['（1）税金：按照工作总经费的6%计算。', '税金=（各项工作手段预算费用之和+工地建筑预算费用）×6%=68.55万元。', '（2）1∶2.5万土壤测量自由网、密度为40点/km2，Ⅱ级地形的土壤测量标准的确定：因为网度为100×20米、Ⅱ级地形的土壤测量标准为4097元/km2，网度为100×40米、Ⅱ级地形的土壤测量标准为2540元/km2，点距放大一倍（即采样密度降低一半），标准降低38%。同理，自由网、密度为40点/km2、Ⅱ级地形的土壤测量标准应在网度为250×50米（即采样密度为80点/km）Ⅱ级地形的土壤测量标准为818元/km2的62%，即507.16元/km2。', '（3）1∶2.5万土壤测量因采用自由网，不能进行测网布设，但需要用手持GPS进行确定采样点位，这样会增加设备使用成本，同时也会降低生产效率，故按网度为250×50米（即采样密度为80点/km2）、Ⅱ级地形的土壤测量标准818元/km2的20%考虑，即163.60元/km2。', '（4）预算编制过程中广域大地电磁测深在中国地质调查局《地质调查项目预算标准》（2010年试用）中没有对应的定额标准，本次预算参照山东省地质调查预算标准（鲁财资环〔2020〕30号）中对应工作手段预算标准计算。', '（5）预算编制过程中微量分析在中国地质调查局《地质调查项目预算标准》（2010年试用）中没有对应的定额标准，本次预算参照中国地质调查局《地质调查项目预算标准》（2021年）中微量稀土分析预算标注723元/件计算。'], 'children': []}]}, {'title': '二、预算表', 'paragraphs': '“内蒙古四子王旗小南山一带铜镍多金属矿区块优选调查评价”项目概算经费为1211.00万元，由《地质勘查项目设计预算汇总表（甲类）》“预算甲—1表”和《地质勘查项目设计预算表（甲类）》“预算甲—2表”构成。', 'children': []}]
    doc = DocumentPrase()
    result = doc.extract_paragraphs(data)

    print(result)

    # summarizer = DocumentSummarizer()
    # result = summarizer.generate_summary(result)
    # print(result)
    generator = SummaryGenerator(model_name="qwen-plus")

    # 生成摘要
    summary_output = generator.generate_document_summary(result)

    # 打印结果
    if summary_output:
        print(summary_output)
        print("\n--- 生成的摘要 ---")
        print("\n章节摘要:")
    #     for title, summary in summary_output['section_summaries'].items():
    #         # print(f"  {title}: {summary}")
    #         print(f"  {title}")
    #     print(f"\n整体摘要:\n{summary_output['overall_summary']}")
    # else:
    #     print("\n未能成功生成文档摘要。")




